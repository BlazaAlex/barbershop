<?php
global $conn;
session_start();
include 'db.php';

if (!isset($_SESSION['user_id'])) {
    header("Location: login.php");
    exit;
}

// Define time slots (every half-hour from 10:00 AM to 8:00 PM)
$start_time = new DateTime('10:00');
$end_time = new DateTime('20:00');
$interval = new DateInterval('PT30M'); // 30 minute interval

$time_slots = [];
$period = new DatePeriod($start_time, $interval, $end_time);
foreach ($period as $time) {
    $time_slots[] = $time;
}

$is_admin = ($_SESSION['role'] == 'admin');

// Fetch reservations
if ($is_admin) {
    $stmt = $conn->prepare("
        SELECT r.id, r.appointment_date, r.service, b.name as barber_name, u.username as customer_name
        FROM b_rezervace r
        JOIN b_barbers b ON r.barber_id = b.id
        JOIN b_zakaznici u ON r.user_id = u.id
        ORDER BY r.appointment_date
    ");
} else {
    $stmt = $conn->prepare("
        SELECT r.id, r.appointment_date, r.service, b.name as barber_name
        FROM b_rezervace r
        JOIN b_barbers b ON r.barber_id = b.id
        ORDER BY r.appointment_date
    ");
}
$stmt->execute();
$result_reservations = $stmt->get_result();

$reservations = [];
if ($result_reservations->num_rows > 0) {
    while ($row = $result_reservations->fetch_assoc()) {
        $reservations[] = $row;
    }
}

// Fetch barbers
$stmt_barbers = $conn->prepare("SELECT id, name FROM b_barbers ORDER BY name");
$stmt_barbers->execute();
$result_barbers = $stmt_barbers->get_result();

$barbers = [];
if ($result_barbers->num_rows > 0) {
    while ($row = $result_barbers->fetch_assoc()) {
        $barbers[] = $row;
    }
}

// Generate dates for the next 7 days, excluding Sundays
$dates = [];
for ($i = 0; $i < 7; $i++) {
    $current_date = (new DateTime())->add(new DateInterval("P{$i}D"));
    if ($current_date->format('N') < 7) { // Exclude Sundays (N=7)
        $dates[] = $current_date;
    }
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barber Shop Reservation System</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<h1>Welcome, <?php echo htmlspecialchars($_SESSION['username'], ENT_QUOTES, 'UTF-8'); ?>!</h1>
<?php if (isset($_SESSION['username'])): ?>
    <a href="reserve.php">Make a Reservation</a><br>
    <a href="logout.php">Logout</a>
<?php else: ?>
    <a href="login.php">Login</a>
    <a href="register.php">Register</a>
<?php endif; ?>

<h2>Reservations</h2>
<?php foreach ($dates as $date): ?>
    <h3><?php echo htmlspecialchars($date->format('Y-m-d'), ENT_QUOTES, 'UTF-8'); ?> (<?php echo htmlspecialchars($date->format('l'), ENT_QUOTES, 'UTF-8'); ?>)</h3>
    <table>
        <thead>
        <tr>
            <th>Barber Name</th>
            <?php foreach ($time_slots as $slot): ?>
                <th><?php echo htmlspecialchars($slot->format('H:i'), ENT_QUOTES, 'UTF-8'); ?></th>
            <?php endforeach; ?>
        </tr>
        </thead>
        <tbody>
        <?php foreach ($barbers as $barber): ?>
            <tr>
                <td><?php echo htmlspecialchars($barber['name'], ENT_QUOTES, 'UTF-8'); ?></td>
                <?php foreach ($time_slots as $slot): ?>
                    <?php
                    $slot_str = $date->format('Y-m-d') . ' ' . $slot->format('H:i:s');
                    $found = false;
                    foreach ($reservations as $reservation) {
                        if ($reservation['barber_name'] == $barber['name'] && (new DateTime($reservation['appointment_date']))->format('Y-m-d H:i:s') == $slot_str) {
                            echo "<td class='occupied'>";
                            echo htmlspecialchars($reservation['service'], ENT_QUOTES, 'UTF-8');
                            if ($is_admin) {
                                echo " - " . htmlspecialchars($reservation['customer_name'], ENT_QUOTES, 'UTF-8');
                                echo " <a href='reservation_detail.php?id=" . htmlspecialchars($reservation['id'], ENT_QUOTES, 'UTF-8') . "' class='manage-button'>Manage Reservation</a>";
                            }
                            echo "</td>";
                            $found = true;
                            break;
                        }
                    }
                    if (!$found) {
                        echo "<td class='free'>Free</td>";
                    }
                    ?>
                <?php endforeach; ?>
            </tr>
        <?php endforeach; ?>
        </tbody>
    </table>
<?php endforeach; ?>
</body>
</html>
